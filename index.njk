---
layout: layouts/base.njk
title: PeerTalk Metrics Dashboard
---

<div class="dashboard-header">
  <h1>PeerTalk Metrics Dashboard</h1>
  {% if allMetrics.length > 0 %}
  <p class="last-update">Last updated: {{ allMetrics[0].timestamp | dateFormat }}</p>
  <p class="commit-info">
    Branch: <code>{{ allMetrics[0].branch }}</code> |
    Commit: <code>{{ allMetrics[0].commit }}</code>
  </p>
  {% else %}
  <p class="last-update">No metrics data available yet</p>
  {% endif %}
</div>

{% if allMetrics.length > 0 %}
<div class="metrics-grid">
  <!-- Test Results Card -->
  <div class="metric-card {% if allMetrics[0].test_results.pass_rate == 100 %}success{% else %}warning{% endif %}">
    <h3>Test Pass Rate</h3>
    <div class="metric-value">{{ allMetrics[0].test_results.pass_rate }}%</div>
    <p class="metric-subtitle">
      {{ allMetrics[0].test_results.passed }}/{{ allMetrics[0].test_results.total_tests }} tests passing
    </p>
  </div>

  <!-- Coverage Card -->
  <div class="metric-card {% if allMetrics[0].coverage.line_coverage >= 40 %}success{% else %}warning{% endif %}">
    <h3>Line Coverage</h3>
    <div class="metric-value">{{ allMetrics[0].coverage.line_coverage }}%</div>
    <p class="metric-subtitle">
      {{ allMetrics[0].coverage.lines_covered }}/{{ allMetrics[0].coverage.lines_total }} lines
      {% if allMetrics.length > 1 %}
      <span class="trend">{{ allMetrics[0].coverage.line_coverage | percentChange(allMetrics[1].coverage.line_coverage) }}% change</span>
      {% endif %}
    </p>
  </div>

  <!-- ISR Safety Card -->
  <div class="metric-card {% if allMetrics[0].isr_safety.total_violations == 0 %}success{% else %}error{% endif %}">
    <h3>ISR Safety</h3>
    <div class="metric-value">{{ allMetrics[0].isr_safety.total_violations }}</div>
    <p class="metric-subtitle">violations detected</p>
  </div>

  <!-- CI Timing Card -->
  <div class="metric-card">
    <h3>CI Build Time</h3>
    <div class="metric-value">{{ allMetrics[0].ci_metrics.total_duration_sec }}s</div>
    <p class="metric-subtitle">
      Build: {{ allMetrics[0].ci_metrics.build_duration_sec }}s |
      Test: {{ allMetrics[0].ci_metrics.test_duration_sec }}s
    </p>
  </div>
</div>

<!-- Charts Section -->
<div class="charts-section">
  <div class="chart-container">
    <h2>Test Pass Rate Trend</h2>
    <canvas id="chart-test-results" width="400" height="200"></canvas>
  </div>

  <div class="chart-container">
    <h2>Coverage Trends</h2>
    <canvas id="chart-coverage" width="400" height="200"></canvas>
  </div>

  <div class="chart-container">
    <h2>Code Quality</h2>
    <canvas id="chart-quality" width="400" height="200"></canvas>
  </div>

  <div class="chart-container">
    <h2>CI Performance</h2>
    <canvas id="chart-ci-timing" width="400" height="200"></canvas>
  </div>
</div>

<script src="assets/js/chart.min.js"></script>
<script>
// Prepare data
const metrics = {{ allMetrics | slice(0, 30) | dump | safe }};
const labels = metrics.map(m => m.date).reverse();

// Test Results Chart
new Chart(document.getElementById('chart-test-results'), {
  type: 'line',
  data: {
    labels: labels,
    datasets: [{
      label: 'Pass Rate (%)',
      data: metrics.map(m => m.test_results.pass_rate).reverse(),
      borderColor: 'rgb(75, 192, 192)',
      tension: 0.1
    }]
  },
  options: {
    responsive: true,
    scales: {
      y: { min: 0, max: 100 }
    }
  }
});

// Coverage Chart
new Chart(document.getElementById('chart-coverage'), {
  type: 'line',
  data: {
    labels: labels,
    datasets: [
      {
        label: 'Line Coverage (%)',
        data: metrics.map(m => m.coverage.line_coverage).reverse(),
        borderColor: 'rgb(54, 162, 235)',
        tension: 0.1
      },
      {
        label: 'Function Coverage (%)',
        data: metrics.map(m => m.coverage.function_coverage).reverse(),
        borderColor: 'rgb(153, 102, 255)',
        tension: 0.1
      }
    ]
  },
  options: {
    responsive: true,
    scales: {
      y: { min: 0, max: 100 }
    }
  }
});

// Quality Chart
new Chart(document.getElementById('chart-quality'), {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [
      {
        label: 'Files > 500 Lines',
        data: metrics.map(m => m.quality.files_over_500_lines).reverse(),
        backgroundColor: 'rgba(255, 99, 132, 0.5)'
      },
      {
        label: 'TODO Count',
        data: metrics.map(m => m.quality.todo_count).reverse(),
        backgroundColor: 'rgba(255, 206, 86, 0.5)'
      }
    ]
  },
  options: {
    responsive: true
  }
});

// CI Timing Chart
new Chart(document.getElementById('chart-ci-timing'), {
  type: 'line',
  data: {
    labels: labels,
    datasets: [{
      label: 'Total Duration (s)',
      data: metrics.map(m => m.ci_metrics.total_duration_sec).reverse(),
      borderColor: 'rgb(255, 159, 64)',
      tension: 0.1
    }]
  },
  options: {
    responsive: true
  }
});
</script>

{% else %}
<p class="no-data">No metrics data available. Metrics will appear after first CI run.</p>
{% endif %}
