name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request:
    types: [opened, synchronize]

jobs:
  # Respond to @claude mentions in issues and PRs
  claude-respond:
    runs-on: ubuntu-latest
    # Only run when @claude is mentioned OR for specific trigger events
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'assigned' && github.event.assignee.login == 'claude[bot]') ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'claude-review'))
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # Use Claude Opus 4.5 for best results
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 25
          # Timeout after 30 minutes
          timeout_minutes: 30

  # Auto-review PRs with claude-review label
  claude-pr-review:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'claude-review')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Review PR with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are reviewing PeerTalk code - a cross-platform Classic Mac networking library.

            CRITICAL: Before reviewing, read these project knowledge files:
            - CLAUDE.md (main project rules, ISR safety tables, API patterns)
            - .claude/rules/isr-safety.md (interrupt-time safety rules)
            - .claude/rules/mactcp.md (MacTCP ASR patterns, 68k specific)
            - .claude/rules/opentransport.md (OT notifier patterns, PPC specific)
            - .claude/rules/appletalk.md (ADSP callback patterns, userFlags requirement)

            Review this PR for:

            1. **ISR SAFETY** (CRITICAL for Mac code):
               - Check ASR/notifier/callback functions against forbidden_calls list
               - TickCount() NOT allowed at interrupt time
               - malloc/NewPtr/NewHandle NOT allowed at interrupt time
               - memcpy should use pt_memcpy_isr() in callbacks
               - Must use "set flag, process later" pattern

            2. **ADSP userFlags** (if AppleTalk code):
               - userFlags MUST be cleared after reading (ccb->userFlags = 0)
               - Failure to clear causes connection to hang

            3. **MacTCP patterns**:
               - TCPPassiveOpen is one-shot (need stream transfer pattern)
               - TCPNoCopyRcv requires TCPRcvBfrReturn
               - UPP creation required for callbacks

            4. **Memory safety**:
               - Check for leaks (NewPtr without DisposePtr)
               - Buffer sizes (min 4096 for TCP, 2048 for UDP)
               - MaxBlock check pattern

            5. **Code quality** (from CLAUDE.md):
               - Max 100 lines per function (prefer 50)
               - Max 500 lines per file

            Provide specific line references and cite the relevant rule when flagging issues.
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 15

  # Help with issues labeled 'help-wanted'
  claude-issue-help:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'opened' &&
      contains(github.event.issue.labels.*.name, 'help-wanted')
    steps:
      - uses: actions/checkout@v4

      - name: Analyze Issue
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Analyze this issue and provide:
            1. Which phase/session this relates to (check plan/PHASE-*.md files)
            2. Relevant files that would need to be modified
            3. Key considerations from CLAUDE.md (especially ISR safety for Mac code)
            4. A suggested approach
          claude_args: |
            --model claude-opus-4-5-20251101
            --max-turns 5
