name: Nightly Analysis

on:
  schedule:
    # Run at 3 AM UTC every day
    - cron: '0 3 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  cppcheck-full:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build POSIX Docker image (with cache)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.posix
          push: false
          load: true
          tags: peertalk-posix:latest
          cache-from: type=gha,scope=posix
          cache-to: type=gha,mode=max,scope=posix

      - name: Run cppcheck with --force (all configurations)
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace -u $(id -u):$(id -g) peertalk-posix:latest bash -c '
            mkdir -p build/analysis

            echo "Running cppcheck with --force (all #ifdef configurations)..."
            echo "This analyzes all 19+ configurations and takes longer than normal CI."
            echo ""

            cppcheck \
              --force \
              --enable=all \
              --xml \
              --xml-version=2 \
              --suppress=missingIncludeSystem \
              --suppress=unusedFunction \
              --suppress=unmatchedSuppression \
              --inline-suppr \
              -I include \
              -I src/core \
              --platform=unix64 \
              src include 2> build/analysis/cppcheck-full.xml || true

            # Convert XML to readable summary
            python3 << PYEOF
import xml.etree.ElementTree as ET
import sys

try:
    tree = ET.parse("build/analysis/cppcheck-full.xml")
    root = tree.getroot()
except Exception as e:
    print(f"Failed to parse XML: {e}")
    sys.exit(0)

severity_counts = {}
issues = []

errors = root.find("errors")
if errors is not None:
    for error in errors.findall("error"):
        sev = error.get("severity", "unknown")
        severity_counts[sev] = severity_counts.get(sev, 0) + 1

        loc = error.find("location")
        file_path = loc.get("file", "") if loc is not None else ""
        line = loc.get("line", "0") if loc is not None else "0"

        issues.append({
            "severity": sev,
            "id": error.get("id", ""),
            "msg": error.get("msg", ""),
            "file": file_path,
            "line": line
        })

print("=" * 60)
print("CPPCHECK FULL ANALYSIS (--force)")
print("=" * 60)
print()
print("Summary by severity:")
for sev in ["error", "warning", "style", "performance", "portability", "information"]:
    if sev in severity_counts:
        print(f"  {sev}: {severity_counts[sev]}")
print(f"  TOTAL: {len(issues)}")
print()

# Show errors and warnings
critical = [i for i in issues if i["severity"] in ("error", "warning")]
if critical:
    print("Errors and Warnings:")
    print("-" * 60)
    for i in critical[:30]:
        print(f"[{i['severity'].upper()}] {i['file']}:{i['line']}")
        print(f"  {i['id']}: {i['msg'][:100]}")
        print()
    if len(critical) > 30:
        print(f"... and {len(critical) - 30} more")
else:
    print("No errors or warnings found.")
PYEOF
          '

      - name: Upload cppcheck XML report
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-full-report
          path: build/analysis/cppcheck-full.xml
          retention-days: 30
