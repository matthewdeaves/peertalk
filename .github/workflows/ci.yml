name: PeerTalk CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # POSIX build and tests (runs on every push/PR)
  # Uses lightweight POSIX-only Docker image (no Retro68)
  build-posix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build POSIX Docker image (with cache)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.posix
          push: false
          load: true
          tags: peertalk-posix:latest
          cache-from: type=gha,scope=posix
          cache-to: type=gha,mode=max,scope=posix

      - name: Build POSIX
        run: |
          if [ -f "Makefile" ]; then
            docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace -u $(id -u):$(id -g) peertalk-posix:latest make all
          else
            echo "No Makefile yet - skipping POSIX build"
          fi

      - name: Run tests
        run: |
          if [ -f "Makefile" ]; then
            docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace -u $(id -u):$(id -g) peertalk-posix:latest make test-local || exit 1
            echo "âœ“ All tests passed"
          else
            echo "No Makefile yet - skipping tests"
          fi

      - name: Check coverage
        run: |
          if [ -f "Makefile" ]; then
            docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace -u $(id -u):$(id -g) peertalk-posix:latest bash -c "make coverage-local && lcov --summary build/coverage/coverage.info 2>&1"
            COVERAGE=$(docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace -u $(id -u):$(id -g) peertalk-posix:latest lcov --summary build/coverage/coverage.info 2>&1 | grep "lines" | awk '{print $2}' | tr -d '%')
            echo "Coverage: ${COVERAGE}%"
            if (( $(echo "$COVERAGE < 10.0" | bc -l) )); then
              echo "::warning::Coverage ${COVERAGE}% is below 10% threshold"
            fi
          else
            echo "No Makefile yet - skipping coverage"
          fi

  # ISR safety validation
  validate-isr-safety:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build POSIX Docker image (with cache)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.posix
          push: false
          load: true
          tags: peertalk-posix:latest
          cache-from: type=gha,scope=posix
          cache-to: type=gha,mode=max,scope=posix

      - name: Run ISR Safety Validator
        run: |
          if [ -d "src/" ]; then
            docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace -u $(id -u):$(id -g) peertalk-posix:latest \
              python tools/validators/isr_safety.py src/
          else
            echo "No src/ directory yet - skipping ISR validation"
          fi

  # Build and push full Docker image to GitHub Container Registry
  # This includes Retro68 toolchain for Classic Mac cross-compilation
  # Only runs on main/develop pushes when Docker-related files change
  build-docker:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need history for path filtering

      - name: Check if Docker files changed
        id: filter
        run: |
          # Check if any Docker-related files changed in this push
          if git diff --name-only HEAD~1 HEAD | grep -qE '^docker/Dockerfile$|^resources/retro68/'; then
            echo "docker_changed=true" >> $GITHUB_OUTPUT
            echo "Docker files changed - will build"
          else
            echo "docker_changed=false" >> $GITHUB_OUTPUT
            echo "No Docker changes - skipping build"
          fi

      # Free up disk space for large Docker build
      - name: Free disk space
        if: steps.filter.outputs.docker_changed == 'true'
        run: |
          echo "Before cleanup:"
          df -h /
          # Remove unnecessary large packages
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune -af
          echo "After cleanup:"
          df -h /

      - name: Set up Docker Buildx
        if: steps.filter.outputs.docker_changed == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: steps.filter.outputs.docker_changed == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        if: steps.filter.outputs.docker_changed == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/peertalk-dev
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push Docker image
        if: steps.filter.outputs.docker_changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=retro68
          cache-to: type=gha,mode=max,scope=retro68

      - name: Skip notification
        if: steps.filter.outputs.docker_changed == 'false'
        run: echo "Docker build skipped - no changes to docker/Dockerfile or resources/retro68/"

  # Retro68 cross-compilation - builds PeerTalk SDK library for Classic Mac platforms
  build-retro68:
    runs-on: ubuntu-latest
    needs: [build-docker]
    # Only run on main branch or when explicitly requested
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'build-retro68')
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: docker pull ghcr.io/${{ github.repository_owner }}/peertalk-dev:latest || docker pull ghcr.io/${{ github.repository_owner }}/peertalk-dev:main

      - name: Tag image for local use
        run: docker tag ghcr.io/${{ github.repository_owner }}/peertalk-dev:latest peertalk-dev:latest 2>/dev/null || docker tag ghcr.io/${{ github.repository_owner }}/peertalk-dev:main peertalk-dev:latest

      - name: Build PeerTalk SDK for 68k (MacTCP)
        run: |
          if [ -f "Makefile.retro68" ]; then
            docker run --rm -v ${{ github.workspace }}:/workspace peertalk-dev:latest \
              make -f Makefile.retro68 PLATFORM=mactcp
          else
            echo "No Makefile.retro68 yet - skipping SDK build for 68k"
          fi

      - name: Build PeerTalk SDK for PPC (Open Transport)
        run: |
          if [ -f "Makefile.retro68" ]; then
            docker run --rm -v ${{ github.workspace }}:/workspace peertalk-dev:latest \
              make -f Makefile.retro68 PLATFORM=ot
          else
            echo "No Makefile.retro68 yet - skipping SDK build for PPC"
          fi

  # Code quality gates
  quality-gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build POSIX Docker image (with cache)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.posix
          push: false
          load: true
          tags: peertalk-posix:latest
          cache-from: type=gha,scope=posix
          cache-to: type=gha,mode=max,scope=posix

      - name: Check file sizes
        run: |
          echo "Checking file sizes (max 500 lines)..."
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace -u $(id -u):$(id -g) peertalk-posix:latest bash -c '
            ERRORS=0
            for f in $(find . \( -name "*.c" -o -name "*.h" \) | grep -v node_modules); do
              lines=$(wc -l < "$f")
              if [ "$lines" -gt 500 ]; then
                echo "::warning file=$f::$f has $lines lines (max 500)"
                ERRORS=$((ERRORS + 1))
              fi
            done
            if [ $ERRORS -gt 0 ]; then
              echo "::warning::$ERRORS files exceed 500 line limit"
            fi
          '

      - name: Check for TODO/FIXME
        run: |
          echo "Checking for unresolved TODOs..."
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace -u $(id -u):$(id -g) peertalk-posix:latest bash -c '
            if grep -rn "TODO\|FIXME" --include="*.c" --include="*.h" . 2>/dev/null; then
              echo "::notice::Found TODO/FIXME comments - consider resolving"
            fi
          '

      - name: Run static analysis
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace -u $(id -u):$(id -g) peertalk-posix:latest bash -c '
            mkdir -p build/analysis
            ./tools/analyze.sh --quick || true
          '

      - name: Check for cppcheck errors
        run: |
          if [ -f build/analysis/cppcheck.json ]; then
            ERRORS=$(python3 -c "import json; d=json.load(open('build/analysis/cppcheck.json')); print(d.get('by_severity', {}).get('error', 0))")
            if [ "$ERRORS" -gt 0 ]; then
              echo "::error::cppcheck found $ERRORS error(s)"
              python3 << 'PYEOF'
          import json
          d = json.load(open('build/analysis/cppcheck.json'))
          for i in [x for x in d.get('issues', []) if x.get('severity') == 'error'][:10]:
              print(f"::error file={i.get('file', '?')},line={i.get('line', 0)}::{i.get('message', '?')}")
          PYEOF
            fi
          fi

      - name: Check code duplication
        run: |
          if [ -f build/analysis/duplicates.json ]; then
            PCT=$(python3 -c "import json; d=json.load(open('build/analysis/duplicates.json')); print(d.get('percentage', 0))")
            if (( $(echo "$PCT > 15" | bc -l) )); then
              echo "::warning::Code duplication is ${PCT}% (threshold: 15%)"
            else
              echo "Code duplication: ${PCT}%"
            fi
          fi

  # Collect metrics and update dashboard
  collect-metrics:
    runs-on: ubuntu-latest
    needs: [build-posix, validate-isr-safety, quality-gates]
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    permissions:
      contents: write  # Needed to push to gh-pages

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for gh-pages

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build POSIX Docker image (with cache)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.posix
          push: false
          load: true
          tags: peertalk-posix:latest
          cache-from: type=gha,scope=posix
          cache-to: type=gha,mode=max,scope=posix

      - name: Build library
        id: build
        run: |
          START_TIME=$(date +%s)
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace -u $(id -u):$(id -g) peertalk-posix:latest \
            make all 2>&1 | tee /tmp/build_output.txt
          BUILD_END=$(date +%s)
          echo "build_duration=$((BUILD_END - START_TIME))" >> $GITHUB_OUTPUT

      - name: Run tests
        id: tests
        run: |
          START_TIME=$(date +%s)
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace -u $(id -u):$(id -g) peertalk-posix:latest \
            make test-local 2>&1 | tee /tmp/test_output.txt
          TEST_END=$(date +%s)
          echo "test_duration=$((TEST_END - START_TIME))" >> $GITHUB_OUTPUT

      - name: Generate coverage
        id: coverage
        run: |
          START_TIME=$(date +%s)
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace -u $(id -u):$(id -g) peertalk-posix:latest \
            make coverage-local
          COV_END=$(date +%s)
          echo "coverage_duration=$((COV_END - START_TIME))" >> $GITHUB_OUTPUT

      - name: Extract metrics
        run: |
          mkdir -p /tmp/metrics
          # Copy test output to workspace so Docker can access it
          cp /tmp/test_output.txt ${{ github.workspace }}/test_output.txt

          # Run all metric extraction in Docker (has all analysis tools)
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -v /tmp/metrics:/metrics \
            -w /workspace \
            -e BUILD_DURATION_SEC="${{ steps.build.outputs.build_duration }}" \
            -e TEST_DURATION_SEC="${{ steps.tests.outputs.test_duration }}" \
            -e COVERAGE_DURATION_SEC="${{ steps.coverage.outputs.coverage_duration }}" \
            peertalk-posix:latest bash -c '
              # click and rich are pre-installed in Docker image

              # Extract test results
              ./tools/metrics/extract_test_results.sh test_output.txt > /metrics/test_results.json

              # Extract test count metrics
              ./tools/metrics/extract_test_count.sh test_output.txt > /metrics/test_count.json

              # Extract coverage metrics
              ./tools/metrics/extract_coverage.sh > /metrics/coverage.json

              # Extract ISR safety metrics
              ./tools/metrics/extract_isr_violations.sh > /metrics/isr_safety.json

              # Extract quality metrics
              ./tools/metrics/extract_quality_metrics.sh > /metrics/quality.json

              # Extract binary size metrics
              ./tools/metrics/extract_binary_size.sh > /metrics/binary_size.json

              # Extract complexity metrics
              ./tools/metrics/extract_complexity.sh > /metrics/complexity.json

              # Extract static analysis metrics (cppcheck)
              ./tools/metrics/extract_cppcheck.sh > /metrics/cppcheck.json

              # Extract code duplication metrics (jscpd)
              ./tools/metrics/extract_duplicates.sh > /metrics/duplicates.json

              # Extract CI metrics (with timing from previous steps)
              ./tools/metrics/extract_ci_metrics.sh > /metrics/ci_metrics.json
            '

      - name: Aggregate metrics
        run: |
          # Run aggregation in Docker
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -v /tmp/metrics:/metrics \
            -w /workspace \
            -e GITHUB_SHA="${{ github.sha }}" \
            -e GITHUB_REF_NAME="${{ github.ref_name }}" \
            peertalk-posix:latest bash -c '
              python3 tools/metrics/aggregate_metrics.py \
                /metrics/test_results.json \
                /metrics/coverage.json \
                /metrics/isr_safety.json \
                /metrics/quality.json \
                /metrics/ci_metrics.json \
                /metrics/aggregated.json \
                /metrics

              echo "Aggregated metrics:"
              cat /metrics/aggregated.json | python3 -m json.tool
            '

      - name: Generate HTML reports
        run: |
          # Generate ISR safety HTML report in Docker
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -v /tmp/metrics:/metrics \
            -w /workspace \
            peertalk-posix:latest bash -c '
              # click and rich are pre-installed in Docker image
              python3 tools/metrics/generate_isr_report.py \
                /metrics/isr_safety.json \
                /metrics/isr_report.html
            '

      - name: Upload to gh-pages
        run: |
          ./tools/metrics/upload_to_pages.sh /tmp/metrics/aggregated.json build/coverage/html /tmp/metrics/isr_report.html
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
