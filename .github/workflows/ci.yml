name: PeerTalk CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # POSIX build and tests (runs on every push/PR)
  build-posix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y gcc make lcov bc

      - name: Build POSIX
        run: |
          if [ -f "Makefile" ]; then
            make
          else
            echo "No Makefile yet - skipping POSIX build"
          fi

      - name: Run tests
        run: |
          if [ -f "Makefile" ]; then
            make test
          else
            echo "No Makefile yet - skipping tests"
          fi

      - name: Check coverage
        run: |
          if [ -f "Makefile" ]; then
            make coverage
            COVERAGE=$(lcov --summary coverage.info 2>&1 | grep "lines" | awk '{print $2}' | tr -d '%')
            echo "Coverage: ${COVERAGE}%"
            if (( $(echo "$COVERAGE < 10.0" | bc -l) )); then
              echo "::warning::Coverage ${COVERAGE}% is below 10% threshold"
            fi
          else
            echo "No Makefile yet - skipping coverage"
          fi

  # ISR safety validation
  validate-isr-safety:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install validator dependencies
        run: pip install click rich

      - name: Run ISR Safety Validator
        run: |
          if [ -d "src/" ]; then
            python tools/validators/isr_safety.py src/
          else
            echo "No src/ directory yet - skipping ISR validation"
          fi

  # Retro68 cross-compilation - builds PeerTalk SDK library for Classic Mac platforms
  build-retro68:
    runs-on: ubuntu-latest
    # Only run on main branch or when Docker/Mac code changes
    if: github.ref == 'refs/heads/main' || contains(github.event.pull_request.labels.*.name, 'build-retro68')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: false
          load: true
          tags: peertalk-dev:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build PeerTalk SDK for 68k (MacTCP)
        run: |
          if [ -f "Makefile.retro68" ]; then
            docker run --rm -v ${{ github.workspace }}:/workspace peertalk-dev:latest \
              make -f Makefile.retro68 PLATFORM=mactcp
          else
            echo "No Makefile.retro68 yet - skipping SDK build for 68k"
          fi

      - name: Build PeerTalk SDK for PPC (Open Transport)
        run: |
          if [ -f "Makefile.retro68" ]; then
            docker run --rm -v ${{ github.workspace }}:/workspace peertalk-dev:latest \
              make -f Makefile.retro68 PLATFORM=ot
          else
            echo "No Makefile.retro68 yet - skipping SDK build for PPC"
          fi

  # Code quality gates
  quality-gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check file sizes
        run: |
          echo "Checking file sizes (max 500 lines)..."
          ERRORS=0
          for f in $(find . \( -name "*.c" -o -name "*.h" \) | grep -v node_modules); do
            lines=$(wc -l < "$f")
            if [ "$lines" -gt 500 ]; then
              echo "::warning file=$f::$f has $lines lines (max 500)"
              ERRORS=$((ERRORS + 1))
            fi
          done
          if [ $ERRORS -gt 0 ]; then
            echo "::warning::$ERRORS files exceed 500 line limit"
          fi

      - name: Check for TODO/FIXME
        run: |
          echo "Checking for unresolved TODOs..."
          if grep -rn "TODO\|FIXME" --include="*.c" --include="*.h" . 2>/dev/null; then
            echo "::notice::Found TODO/FIXME comments - consider resolving"
          fi
