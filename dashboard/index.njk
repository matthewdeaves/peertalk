---
layout: layouts/base.njk
title: PeerTalk Metrics Dashboard
---

<div class="dashboard-header">
  <h1>PeerTalk Metrics Dashboard</h1>

  <div class="branch-selector">
    <label for="branch-select">Branch:</label>
    <select id="branch-select">
      {% for branch in availableBranches %}
      <option value="{{ branch }}" {% if branch == defaultBranch %}selected{% endif %}>{{ branch }}</option>
      {% endfor %}
    </select>
  </div>

  <p class="last-update" id="last-update">Loading...</p>
  <p class="commit-info" id="commit-info"></p>
</div>

<div id="metrics-content">
  <div class="metrics-grid">
    <!-- Test Results Card - links to test details -->
    <a href="test-results.html" class="metric-card-link" id="card-tests-link">
      <div class="metric-card" id="card-tests">
        <h3>Test Pass Rate</h3>
        <div class="metric-value" id="test-pass-rate">--</div>
        <p class="metric-subtitle" id="test-subtitle">Loading...</p>
        <p class="card-action">View test details &rarr;</p>
      </div>
    </a>

    <!-- Coverage Card - links to coverage report -->
    <a href="coverage/" class="metric-card-link" id="card-coverage-link">
      <div class="metric-card" id="card-coverage">
        <h3>Test Coverage</h3>
        <div class="metric-value" id="line-coverage">--</div>
        <p class="metric-subtitle" id="coverage-subtitle">Loading...</p>
        <p class="card-action">View coverage report &rarr;</p>
      </div>
    </a>

    <!-- ISR Safety Card - links to ISR report -->
    <a href="isr-report.html" class="metric-card-link" id="card-isr-link">
      <div class="metric-card" id="card-isr">
        <h3>ISR Safety</h3>
        <div class="metric-value" id="isr-violations">--</div>
        <p class="metric-subtitle">violations detected</p>
        <p class="card-action">View ISR report &rarr;</p>
      </div>
    </a>

    <!-- Static Analysis Card - links to static analysis report -->
    <a href="static-analysis.html" class="metric-card-link" id="card-static-link">
      <div class="metric-card" id="card-static">
        <h3>Static Analysis</h3>
        <div class="metric-value" id="static-issues">--</div>
        <p class="metric-subtitle" id="static-subtitle">cppcheck issues</p>
        <p class="card-action">View issues &rarr;</p>
      </div>
    </a>
  </div>

  <!-- Charts Section -->
  <div class="charts-section">
    <div class="chart-container">
      <h2>Test Pass Rate Trend</h2>
      <canvas id="chart-test-results" width="400" height="200"></canvas>
    </div>

    <div class="chart-container">
      <h2>Test Coverage Trends</h2>
      <canvas id="chart-coverage" width="400" height="200"></canvas>
    </div>

    <div class="chart-container">
      <h2>Code Quality</h2>
      <canvas id="chart-quality" width="400" height="200"></canvas>
    </div>

    <div class="chart-container">
      <h2>Static Analysis Issues</h2>
      <canvas id="chart-static" width="400" height="200"></canvas>
    </div>
  </div>

  <!-- Commit History Section -->
  <div class="history-section">
    <h2>Recent Commits</h2>
    <div id="commit-history" class="commit-list">
      <p>Loading commit history...</p>
    </div>
  </div>
</div>

<p class="no-data" id="no-data" style="display: none;">No metrics data available for this branch.</p>

<script src="assets/js/chart.min.js"></script>
<script>
const metricsByBranch = {{ metricsByBranch | dump | safe }};
const defaultBranch = "{{ defaultBranch }}";
const ghRepo = "https://github.com/matthewdeaves/peertalk";

let charts = {};

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

function updateCardClass(cardId, condition, successClass, failClass) {
  const card = document.getElementById(cardId);
  card.classList.remove('success', 'warning', 'error');
  card.classList.add(condition ? successClass : failClass);
}

function updateDashboard(branch) {
  const metrics = metricsByBranch[branch] || [];
  const content = document.getElementById('metrics-content');
  const noData = document.getElementById('no-data');

  if (metrics.length === 0) {
    content.style.display = 'none';
    noData.style.display = 'block';
    return;
  }

  content.style.display = 'block';
  noData.style.display = 'none';

  const latest = metrics[0];

  // Update header info
  document.getElementById('last-update').textContent =
    'Last updated: ' + formatDate(latest.timestamp || latest.date);

  const commitLink = latest.commit
    ? '<a href="' + ghRepo + '/commit/' + latest.commit + '">' + latest.commit.substring(0, 7) + '</a>'
    : 'unknown';
  document.getElementById('commit-info').innerHTML =
    'Branch: <code>' + (latest.branch || branch) + '</code> | Commit: ' + commitLink;

  // Update cards
  document.getElementById('test-pass-rate').textContent = latest.test_results.pass_rate + '%';
  document.getElementById('test-subtitle').textContent =
    latest.test_results.passed + '/' + latest.test_results.total_tests + ' tests passing';
  updateCardClass('card-tests', latest.test_results.pass_rate === 100, 'success', 'warning');

  document.getElementById('line-coverage').textContent = latest.coverage.line_coverage + '%';
  document.getElementById('coverage-subtitle').textContent =
    latest.coverage.lines_covered + '/' + latest.coverage.lines_total + ' lines covered by tests';
  updateCardClass('card-coverage', latest.coverage.line_coverage >= 40, 'success', 'warning');

  document.getElementById('isr-violations').textContent = latest.isr_safety.total_violations;
  updateCardClass('card-isr', latest.isr_safety.total_violations === 0, 'success', 'error');

  const staticIssues = latest.static_analysis ? latest.static_analysis.total_issues : 0;
  document.getElementById('static-issues').textContent = staticIssues;
  updateCardClass('card-static', staticIssues === 0, 'success', 'warning');

  // Update card links to pass branch parameter
  document.getElementById('card-tests-link').href = 'test-results.html?branch=' + branch;
  document.getElementById('card-static-link').href = 'static-analysis.html?branch=' + branch;

  // Update commit history
  updateCommitHistory(metrics.slice(0, 10), branch);

  // Update charts
  updateCharts(metrics.slice(0, 30));
}

function updateCommitHistory(metrics, branch) {
  const container = document.getElementById('commit-history');
  if (metrics.length === 0) {
    container.innerHTML = '<p>No commit history available.</p>';
    return;
  }

  let html = '<table class="history-table"><thead><tr>';
  html += '<th>Date</th><th>Commit</th><th>Tests</th><th>Coverage</th><th>ISR</th><th>Static</th>';
  html += '</tr></thead><tbody>';

  for (const m of metrics) {
    const commitLink = m.commit
      ? '<a href="' + ghRepo + '/commit/' + m.commit + '">' + m.commit.substring(0, 7) + '</a>'
      : '-';
    const testClass = m.test_results.pass_rate === 100 ? 'good' : 'bad';
    const coverageClass = m.coverage.line_coverage >= 40 ? 'good' : 'bad';
    const isrClass = m.isr_safety.total_violations === 0 ? 'good' : 'bad';
    const staticIssues = m.static_analysis ? m.static_analysis.total_issues : 0;
    const staticClass = staticIssues === 0 ? 'good' : 'neutral';

    html += '<tr>';
    html += '<td>' + m.date + '</td>';
    html += '<td>' + commitLink + '</td>';
    html += '<td class="' + testClass + '">' + m.test_results.pass_rate + '%</td>';
    html += '<td class="' + coverageClass + '">' + m.coverage.line_coverage + '%</td>';
    html += '<td class="' + isrClass + '">' + m.isr_safety.total_violations + '</td>';
    html += '<td class="' + staticClass + '">' + staticIssues + '</td>';
    html += '</tr>';
  }

  html += '</tbody></table>';
  container.innerHTML = html;
}

function updateCharts(metrics) {
  const labels = metrics.map(m => m.date).reverse();

  Object.values(charts).forEach(chart => chart.destroy());
  charts = {};

  charts.testResults = new Chart(document.getElementById('chart-test-results'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Pass Rate (%)',
        data: metrics.map(m => m.test_results.pass_rate).reverse(),
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      }]
    },
    options: { responsive: true, scales: { y: { min: 0, max: 100 } } }
  });

  charts.coverage = new Chart(document.getElementById('chart-coverage'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Line Coverage (%)',
          data: metrics.map(m => m.coverage.line_coverage).reverse(),
          borderColor: 'rgb(54, 162, 235)',
          tension: 0.1
        },
        {
          label: 'Function Coverage (%)',
          data: metrics.map(m => m.coverage.function_coverage).reverse(),
          borderColor: 'rgb(153, 102, 255)',
          tension: 0.1
        }
      ]
    },
    options: { responsive: true, scales: { y: { min: 0, max: 100 } } }
  });

  charts.quality = new Chart(document.getElementById('chart-quality'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Files > 500 Lines',
          data: metrics.map(m => m.quality.files_over_500_lines).reverse(),
          backgroundColor: 'rgba(255, 99, 132, 0.5)'
        },
        {
          label: 'TODO Count',
          data: metrics.map(m => m.quality.todo_count).reverse(),
          backgroundColor: 'rgba(255, 206, 86, 0.5)'
        }
      ]
    },
    options: { responsive: true }
  });

  charts.staticAnalysis = new Chart(document.getElementById('chart-static'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Cppcheck Issues',
        data: metrics.map(m => m.static_analysis ? m.static_analysis.total_issues : 0).reverse(),
        borderColor: 'rgb(255, 99, 132)',
        tension: 0.1
      }]
    },
    options: { responsive: true, scales: { y: { min: 0 } } }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  updateDashboard(defaultBranch);
  document.getElementById('branch-select').addEventListener('change', function(e) {
    updateDashboard(e.target.value);
  });
});
</script>
