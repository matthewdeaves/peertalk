---
layout: layouts/base.njk
title: PeerTalk Metrics Dashboard
---

<div class="dashboard-header">
  <h1>PeerTalk Metrics Dashboard</h1>

  <div class="branch-selector">
    <label for="branch-select">Branch:</label>
    <select id="branch-select">
      {% for branch in availableBranches %}
      <option value="{{ branch }}" {% if branch == defaultBranch %}selected{% endif %}>{{ branch }}</option>
      {% endfor %}
    </select>
  </div>

  <p class="last-update" id="last-update">Loading...</p>
  <p class="commit-info" id="commit-info"></p>
</div>

<div id="metrics-content">
  <div class="metrics-grid">
    <!-- Test Results Card -->
    <div class="metric-card" id="card-tests">
      <h3>Test Pass Rate</h3>
      <div class="metric-value" id="test-pass-rate">--</div>
      <p class="metric-subtitle" id="test-subtitle">Loading...</p>
    </div>

    <!-- Coverage Card -->
    <div class="metric-card" id="card-coverage">
      <h3>Test Coverage</h3>
      <div class="metric-value" id="line-coverage">--</div>
      <p class="metric-subtitle" id="coverage-subtitle">Loading...</p>
    </div>

    <!-- ISR Safety Card -->
    <div class="metric-card" id="card-isr">
      <h3>ISR Safety</h3>
      <div class="metric-value" id="isr-violations">--</div>
      <p class="metric-subtitle">violations detected</p>
    </div>

    <!-- Static Analysis Card -->
    <div class="metric-card" id="card-static">
      <h3>Static Analysis</h3>
      <div class="metric-value" id="static-issues">--</div>
      <p class="metric-subtitle" id="static-subtitle">cppcheck issues</p>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-section">
    <div class="chart-container">
      <h2>Test Pass Rate Trend</h2>
      <canvas id="chart-test-results" width="400" height="200"></canvas>
    </div>

    <div class="chart-container">
      <h2>Test Coverage Trends</h2>
      <canvas id="chart-coverage" width="400" height="200"></canvas>
    </div>

    <div class="chart-container">
      <h2>Code Quality</h2>
      <canvas id="chart-quality" width="400" height="200"></canvas>
    </div>

    <div class="chart-container">
      <h2>Static Analysis Issues</h2>
      <canvas id="chart-static" width="400" height="200"></canvas>
    </div>
  </div>

  <!-- Detailed Reports Section -->
  <div class="reports-section">
    <h2>Detailed Reports</h2>
    <div class="reports-grid">
      <a href="coverage/" class="report-card">
        <h3>Coverage Report</h3>
        <p>Detailed line-by-line test coverage with source highlighting</p>
      </a>
      <a href="isr-report.html" class="report-card">
        <h3>ISR Safety Report</h3>
        <p>Interrupt-time safety violations for Classic Mac callback code</p>
      </a>
    </div>
  </div>
</div>

<p class="no-data" id="no-data" style="display: none;">No metrics data available for this branch.</p>

<script src="assets/js/chart.min.js"></script>
<script>
// All metrics data organized by branch
const metricsByBranch = {{ metricsByBranch | dump | safe }};
const defaultBranch = "{{ defaultBranch }}";

// Chart instances (so we can destroy and recreate them)
let charts = {};

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

function updateCardClass(cardId, condition, successClass, failClass) {
  const card = document.getElementById(cardId);
  card.classList.remove('success', 'warning', 'error');
  card.classList.add(condition ? successClass : failClass);
}

function updateDashboard(branch) {
  const metrics = metricsByBranch[branch] || [];
  const content = document.getElementById('metrics-content');
  const noData = document.getElementById('no-data');

  if (metrics.length === 0) {
    content.style.display = 'none';
    noData.style.display = 'block';
    return;
  }

  content.style.display = 'block';
  noData.style.display = 'none';

  const latest = metrics[0];

  // Update header info
  document.getElementById('last-update').textContent =
    'Last updated: ' + formatDate(latest.timestamp || latest.date);
  document.getElementById('commit-info').innerHTML =
    'Branch: <code>' + (latest.branch || branch) + '</code> | Commit: <code>' +
    (latest.commit ? latest.commit.substring(0, 7) : 'unknown') + '</code>';

  // Update cards
  document.getElementById('test-pass-rate').textContent = latest.test_results.pass_rate + '%';
  document.getElementById('test-subtitle').textContent =
    latest.test_results.passed + '/' + latest.test_results.total_tests + ' tests passing';
  updateCardClass('card-tests', latest.test_results.pass_rate === 100, 'success', 'warning');

  document.getElementById('line-coverage').textContent = latest.coverage.line_coverage + '%';
  let coverageSubtitle = latest.coverage.lines_covered + '/' + latest.coverage.lines_total + ' lines covered by tests';
  document.getElementById('coverage-subtitle').innerHTML = coverageSubtitle;
  updateCardClass('card-coverage', latest.coverage.line_coverage >= 40, 'success', 'warning');

  document.getElementById('isr-violations').textContent = latest.isr_safety.total_violations;
  updateCardClass('card-isr', latest.isr_safety.total_violations === 0, 'success', 'error');

  // Static analysis (cppcheck) - get from static_analysis if available, otherwise 0
  const staticIssues = latest.static_analysis ? latest.static_analysis.total_issues : 0;
  document.getElementById('static-issues').textContent = staticIssues;
  updateCardClass('card-static', staticIssues === 0, 'success', 'warning');

  // Update charts
  updateCharts(metrics.slice(0, 30));
}

function updateCharts(metrics) {
  const labels = metrics.map(m => m.date).reverse();

  // Destroy existing charts
  Object.values(charts).forEach(chart => chart.destroy());
  charts = {};

  // Test Results Chart
  charts.testResults = new Chart(document.getElementById('chart-test-results'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Pass Rate (%)',
        data: metrics.map(m => m.test_results.pass_rate).reverse(),
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { min: 0, max: 100 }
      }
    }
  });

  // Coverage Chart
  charts.coverage = new Chart(document.getElementById('chart-coverage'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Line Coverage (%)',
          data: metrics.map(m => m.coverage.line_coverage).reverse(),
          borderColor: 'rgb(54, 162, 235)',
          tension: 0.1
        },
        {
          label: 'Function Coverage (%)',
          data: metrics.map(m => m.coverage.function_coverage).reverse(),
          borderColor: 'rgb(153, 102, 255)',
          tension: 0.1
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: { min: 0, max: 100 }
      }
    }
  });

  // Quality Chart
  charts.quality = new Chart(document.getElementById('chart-quality'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Files > 500 Lines',
          data: metrics.map(m => m.quality.files_over_500_lines).reverse(),
          backgroundColor: 'rgba(255, 99, 132, 0.5)'
        },
        {
          label: 'TODO Count',
          data: metrics.map(m => m.quality.todo_count).reverse(),
          backgroundColor: 'rgba(255, 206, 86, 0.5)'
        }
      ]
    },
    options: {
      responsive: true
    }
  });

  // Static Analysis Chart
  charts.staticAnalysis = new Chart(document.getElementById('chart-static'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Cppcheck Issues',
        data: metrics.map(m => m.static_analysis ? m.static_analysis.total_issues : 0).reverse(),
        borderColor: 'rgb(255, 99, 132)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { min: 0 }
      }
    }
  });
}

// Initialize with default branch
document.addEventListener('DOMContentLoaded', function() {
  updateDashboard(defaultBranch);

  // Handle branch selection change
  document.getElementById('branch-select').addEventListener('change', function(e) {
    updateDashboard(e.target.value);
  });
});
</script>
