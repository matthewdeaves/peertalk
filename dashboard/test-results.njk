---
layout: layouts/base.njk
title: Test Results
permalink: test-results.html
---

<div class="dashboard-header">
  <h1>Test Results</h1>

  <div class="branch-selector">
    <label for="branch-select">Branch:</label>
    <select id="branch-select">
      {% for branch in availableBranches %}
      <option value="{{ branch }}" {% if branch == defaultBranch %}selected{% endif %}>{{ branch }}</option>
      {% endfor %}
    </select>
  </div>

  <p class="last-update" id="last-update">Individual test pass/fail status</p>
  <p><a href="./">&larr; Back to Dashboard</a></p>
</div>

<div id="test-results-content">
  <div class="report-summary" id="report-summary">
    <p>Loading...</p>
  </div>

  <div class="test-list" id="test-list">
  </div>
</div>

<script>
const metricsByBranch = {{ metricsByBranch | dump | safe }};
const defaultBranch = "{{ defaultBranch }}";
const ghRepo = "https://github.com/matthewdeaves/peertalk";

function getCurrentBranch() {
  const params = new URLSearchParams(window.location.search);
  return params.get('branch') || defaultBranch;
}

function renderReport(branch) {
  const metrics = metricsByBranch[branch] || [];

  // Update branch selector
  document.getElementById('branch-select').value = branch;

  if (metrics.length === 0) {
    document.getElementById('report-summary').innerHTML = '<p>No test data available for this branch.</p>';
    document.getElementById('test-list').innerHTML = '';
    return;
  }

  const latest = metrics[0];
  const tr = latest.test_results;
  const ref = latest.commit || branch;

  // Update last update info
  document.getElementById('last-update').textContent =
    'Branch: ' + branch + ' | Commit: ' + (latest.commit ? latest.commit.substring(0, 7) : 'unknown');

  // Summary
  let summaryHtml = '<div class="summary-grid">';
  summaryHtml += '<div class="summary-card"><h3>Total Tests</h3><div class="summary-value">' + tr.total_tests + '</div></div>';
  summaryHtml += '<div class="summary-card success"><h3>Passed</h3><div class="summary-value">' + tr.passed + '</div></div>';
  summaryHtml += '<div class="summary-card ' + (tr.failed > 0 ? 'error' : '') + '"><h3>Failed</h3><div class="summary-value">' + tr.failed + '</div></div>';
  summaryHtml += '<div class="summary-card"><h3>Pass Rate</h3><div class="summary-value">' + tr.pass_rate + '%</div></div>';
  summaryHtml += '</div>';
  document.getElementById('report-summary').innerHTML = summaryHtml;

  // Test details
  if (!tr.test_details || tr.test_details.length === 0) {
    document.getElementById('test-list').innerHTML = '<p class="no-issues">All tests passing. No detailed breakdown available.</p>';
    return;
  }

  // Link to tests folder on the correct branch
  const testsUrl = ghRepo + '/tree/' + ref + '/tests';

  let testsHtml = '<p class="tests-link">View all tests: <a href="' + testsUrl + '" target="_blank" rel="noopener">tests/</a></p>';
  testsHtml += '<table class="issues-table"><thead><tr>';
  testsHtml += '<th>Status</th><th>Test Name</th>';
  testsHtml += '</tr></thead><tbody>';

  for (const test of tr.test_details) {
    const status = test.status.toUpperCase();
    const statusClass = status === 'PASS' || status === 'OK' ? 'passed' : 'failed';
    const displayStatus = status === 'OK' ? 'PASS' : status;

    // Extract test function name (remove trailing "...")
    const testName = test.name.replace(/\.\.\.+$/, '').trim();

    testsHtml += '<tr class="severity-' + (statusClass === 'passed' ? 'success' : 'error') + '">';
    testsHtml += '<td><span class="status-badge ' + statusClass + '">' + displayStatus + '</span></td>';
    testsHtml += '<td><code>' + testName + '</code></td>';
    testsHtml += '</tr>';
  }

  testsHtml += '</tbody></table>';
  document.getElementById('test-list').innerHTML = testsHtml;
}

document.addEventListener('DOMContentLoaded', function() {
  const branch = getCurrentBranch();
  renderReport(branch);

  document.getElementById('branch-select').addEventListener('change', function(e) {
    const newBranch = e.target.value;
    // Update URL without reload
    const url = new URL(window.location);
    url.searchParams.set('branch', newBranch);
    window.history.pushState({}, '', url);
    renderReport(newBranch);
  });
});
</script>

<style>
.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.summary-card {
  background: var(--bg-card);
  padding: 1rem;
  border-radius: 8px;
  text-align: center;
  border-left: 4px solid var(--color-primary);
}

.summary-card.success { border-left-color: var(--color-success); }
.summary-card.error { border-left-color: var(--color-error); }

.summary-card h3 {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
  text-transform: uppercase;
}

.summary-value {
  font-size: 2rem;
  font-weight: bold;
}

.issues-table {
  width: 100%;
  border-collapse: collapse;
  background: var(--bg-card);
  border-radius: 8px;
  overflow: hidden;
}

.issues-table th,
.issues-table td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid #dee2e6;
}

.issues-table th {
  background: #e9ecef;
  font-weight: 600;
}

.status-badge {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.status-badge.passed { background: #d4edda; color: #155724; }
.status-badge.failed { background: #f8d7da; color: #721c24; }

.no-issues {
  text-align: center;
  padding: 2rem;
  color: var(--text-secondary);
}

.tests-link {
  margin-bottom: 1rem;
}

.tests-link a {
  color: var(--color-primary);
  font-weight: 500;
}

.branch-selector {
  margin-bottom: 1rem;
}

.branch-selector label {
  margin-right: 0.5rem;
}

.branch-selector select {
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  border: 1px solid #dee2e6;
}
</style>
