FROM debian:bookworm-slim

# Install build tools
RUN apt-get update && apt-get install -y \
    build-essential \
    net-tools \
    iputils-ping \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /app

# Copy source and build files
COPY Makefile ./
COPY include ./include/
COPY src ./src/
COPY tests ./tests/

# Build PeerTalk library
RUN make

# Build the integration test
RUN gcc -Wall -Werror -std=c99 -g -O2 -I./include -I./src/core \
    -DPT_LOG_ENABLED -DPT_PLATFORM_POSIX -D_POSIX_C_SOURCE=199309L \
    tests/test_integration_full.c -o test_integration_full \
    -L./build/lib -lpeertalk -lptlog -lpthread

# Run the test
CMD ["./test_integration_full", "default", "both"]
